@if (loadingShow) {
  <div class="h-full min-h-36 flex justify-center items-center">
    <div class="loader"></div>
  </div>
} @else {
  @if (historialPago) {
    <div>
      <div class="p-4">
        <div class="flex items-center gap-2 mb-3">
          <h3 class="font-semibold text-lg">Historial de Pagos</h3>
          @if (pagosPagados() > 0) {
            <span
              class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-600 border border-green-200"
            >
              {{ pagosPagados() }} {{ getPlural(pagosPagados(), 'pagado') }}
            </span>
          }
          @if (pagosPendientes() > 0) {
            <span
              class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-600 border border-amber-200 animate-pulse"
            >
              {{ pagosPendientes() }} {{ getPlural(pagosPendientes(), 'pendiente') }}
            </span>
          }
          @if (pagosAtrasados() > 0) {
            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-600 border border-red-200 animate-pulse">
              {{ pagosAtrasados() }} {{ getPlural(pagosAtrasados(), 'atrasado') }}
            </span>
          }
        </div>

        <div class="space-y-2">
          @for (item of (historialPago?.respHistoriaPago)!.data; track $index) {
            <div class="flex items-center justify-between p-1 rounded-lg bg-white border border-neutral-100 text-xs">
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center">
                  @switch (item.paymentStatus) {
                    @case ('PAGADO') {
                      <img src="assets/icon/pagado.svg" alt="" />
                    }
                    @case ('PENDIENTE') {
                      <img src="assets/icon/pendiente.svg" alt="" />
                    }
                    @case ('ATRASADO') {
                      <img src="assets/icon/atrazado.svg" alt="" />
                    }
                  }
                </div>
                <div>
                  <p class="font-medium">Pago programado</p>
                  <div class="flex items-center gap-2 text-sm text-gray-500">
                    <img src="assets/icon/calendario.svg" alt="" class="h-3.5 w-3.5" />
                    <span>{{ item.paymentDate | custom }}</span>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <div
                  class="px-2.5 py-0.5 rounded-full text-xs font-medium "
                  [ngClass]="{
                    'bg-green-100 text-green-700 border-green-500': item.paymentStatus === 'PAGADO',
                    'bg-red-100 text-red-700 border-red-500 !animate-pulse': item.paymentStatus === 'ATRASADO',
                    'bg-orange-100 text-orange-700 border-orange-500 animate-pulse': item.paymentStatus === 'PENDIENTE'
                  }"

                >
                  <span class="lowercase">{{ item.paymentStatus }}</span>
                </div>
                <div class="flex items-center gap-1 font-medium">
                  <span>
                    {{ item.amountToPay | currency }}
                  </span>
                </div>

                @if (item.paymentStatus !== 'PAGADO') {
                  <div>
                    <button (click)="infoCredito.open(); updatePago.set(item)">
                      <img src="assets/icon/historial.svg" alt="" />
                    </button>
                  </div>
                }
                @if (item.receipt) {
                  <div class="group relative text-xs">
                    <button (click)="toggleMenu(item.ide)">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"
                        />
                      </svg>
                    </button>

                    @if (selectedRow() === item.ide) {
                      <div
                        class="absolute top-8 right-0 mt-2 w-40 bg-gray-800 text-white px-1 py-1 rounded-md shadow-lg z-10"
                      >
                        <ul>
                          @if (item.adjunto !== null) {
                            <a
                              (click)="openDocument(item.adjunto)"
                              class="flex items-center gap-2 py-2 px-3 hover:bg-gray-700 rounded-md cursor-pointer"
                            >
                              <img src="assets/icon/adjunto.svg" alt="adjunto" class="w-5 h-5" />

                              Adjunto
                            </a>
                          }
                          @if (item.receipt !== null) {
                            <a
                              (click)="openDocument(item.receipt)"
                              class="flex items-center gap-2 py-2 px-3 hover:bg-gray-700 rounded-md cursor-pointer"
                            >
                              <img src="assets/icon/vaucher.svg" alt="vaucher" class="w-5 h-5" />

                              Vaucher
                            </a>
                            <hr class="my-2 border-gray-600" />
                          }
                          <li
                            class="flex items-center gap-2 py-2 px-3 hover:bg-gray-700 rounded-md cursor-pointer"
                            (click)="reeviarEmail(item.ide)"
                          >
                            <img src="assets/icon/email.svg" alt="email" class="w-5 h-5" />
                            Reenviar
                          </li>
                        </ul>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  } @else {
    <div class="text-center py-4 max-w-2xl mx-auto">
      <div class="bg-slate-50 py-4 mb-5 rounded-xl">
        <img
          ngSrc="assets/icon/no-application-found.svg"
          alt="Nothing found"
          width="150"
          height="150"
          priority
          class="mx-auto"
        />
      </div>
      <h3 class="text-2xl font-bold">No tiene crédito registrado</h3>
      <p class="text-balance">No se encontraron créditos registrados en esta factura.</p>
    </div>
  }
}

<app-modal #infoCredito>
  @defer {
    <div class="flex items-center justify-center">
      <div class="bg-white w-full max-w-lg rounded-lg overflow-auto shadow-lg">
        <header class="p-4 flex justify-between items-center border-b border-gray-300">
          <h2 class="font-bold text-lg truncate">Registre los detalles de sus pagos</h2>
          <button (click)="infoCredito.close()" class="shrink-0">
            <img ngSrc="/assets/icon/close-icon.svg" width="14" height="18" alt="Close" class="opacity-50" />
          </button>
        </header>
        <section class="p-4">
          @if (updatePago(); as update) {
            <app-update-pago
              [total]="update.amountToPay"
              [letterPayIde]="update.ide"
              (created)="infoCredito.close(); updatePago.set(null)"
              (created)="$event && updateLetterPay($event)"
            />
          }
        </section>
      </div>
    </div>
  }
</app-modal>
@if (isModalOpen()) {
  @defer {
    <app-viewer-document [documentUrl]="currentDocumentUrl()" (close)="closeDocument()" />
  }
}
